-- PostgreSQL database initialization
-- Create database schema for chat system

-- Users table
CREATE TABLE IF NOT EXISTS users (
    user_id VARCHAR(255) PRIMARY KEY,
    username VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Rooms table
CREATE TABLE IF NOT EXISTS rooms (
    room_id VARCHAR(255) PRIMARY KEY,
    room_name VARCHAR(255) NOT NULL,
    room_type VARCHAR(50) DEFAULT 'group', -- 'direct', 'group', 'channel'
    created_by VARCHAR(255) REFERENCES users(user_id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Room members table
CREATE TABLE IF NOT EXISTS room_members (
    id SERIAL PRIMARY KEY,
    room_id VARCHAR(255) REFERENCES rooms(room_id),
    user_id VARCHAR(255) REFERENCES users(user_id),
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    role VARCHAR(50) DEFAULT 'member', -- 'admin', 'member'
    UNIQUE(room_id, user_id)
);

-- Messages table (main storage)
CREATE TABLE IF NOT EXISTS messages (
    message_id BIGINT PRIMARY KEY, -- Generated by Redis INCR
    user_id VARCHAR(255) REFERENCES users(user_id),
    room_id VARCHAR(255) REFERENCES rooms(room_id),
    content TEXT NOT NULL,
    message_type VARCHAR(50) DEFAULT 'text', -- 'text', 'image', 'file'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE
);

-- Devices table (for multi-device support)
CREATE TABLE IF NOT EXISTS devices (
    device_id VARCHAR(255) PRIMARY KEY,
    user_id VARCHAR(255) REFERENCES users(user_id),
    device_type VARCHAR(50), -- 'ios', 'android', 'web', 'desktop'
    device_name VARCHAR(255),
    fcm_token VARCHAR(512), -- For push notifications
    last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_messages_room_id_created_at ON messages(room_id, created_at);
CREATE INDEX IF NOT EXISTS idx_messages_user_id ON messages(user_id);
CREATE INDEX IF NOT EXISTS idx_messages_message_id ON messages(message_id);
CREATE INDEX IF NOT EXISTS idx_room_members_room_id ON room_members(room_id);
CREATE INDEX IF NOT EXISTS idx_room_members_user_id ON room_members(user_id);
CREATE INDEX IF NOT EXISTS idx_devices_user_id ON devices(user_id);

-- Insert sample data for testing
INSERT INTO users (user_id, username, email) VALUES
    ('user1', 'Alice', 'alice@example.com'),
    ('user2', 'Bob', 'bob@example.com'),
    ('user3', 'Charlie', 'charlie@example.com')
ON CONFLICT (user_id) DO NOTHING;

INSERT INTO rooms (room_id, room_name, created_by) VALUES
    ('room1', 'General Chat', 'user1'),
    ('room2', 'Development Team', 'user1'),
    ('room3', 'Random', 'user2')
ON CONFLICT (room_id) DO NOTHING;

INSERT INTO room_members (room_id, user_id, role) VALUES
    ('room1', 'user1', 'admin'),
    ('room1', 'user2', 'member'),
    ('room1', 'user3', 'member'),
    ('room2', 'user1', 'admin'),
    ('room2', 'user2', 'member'),
    ('room3', 'user2', 'admin'),
    ('room3', 'user3', 'member')
ON CONFLICT (room_id, user_id) DO NOTHING;

INSERT INTO devices (device_id, user_id, device_type, device_name) VALUES
    ('device1', 'user1', 'web', 'Alice Web Browser'),
    ('device2', 'user1', 'ios', 'Alice iPhone'),
    ('device3', 'user2', 'android', 'Bob Android'),
    ('device4', 'user3', 'web', 'Charlie Web Browser')
ON CONFLICT (device_id) DO NOTHING;

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Triggers to automatically update updated_at
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_rooms_updated_at BEFORE UPDATE ON rooms
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_messages_updated_at BEFORE UPDATE ON messages
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
