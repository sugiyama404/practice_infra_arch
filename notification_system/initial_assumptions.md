# 要件定義書

## テーマ

開発・検証環境向けメール通知システム（Docker Compose + MailHog）

## ストーリー

サービスのユーザーに送る通知機能を実装する前段階として、まずはメール通知だけを安全に検証できる環境が必要になった。
本番環境に依存せず、開発者がローカル環境で即座に送信・確認できる仕組みを用意する。

## 背景・目的

* 本番のメール送信（SendGrid, SES 等）を直接使うと誤送信リスクが高い。
* 開発環境でメール通知を **非同期処理（メッセージキュー＋ワーカー）付きで再現**し、設計段階でスケーラビリティや処理フローを検証する。
* Docker Compose によって環境構築を簡略化し、誰でも同じ環境で動作確認できるようにする。

## 利用者・規模

* **利用者**: 開発者、QA担当
* **規模**: チーム内で数人〜十数人が利用。
* **アクセス数**: 開発テスト用なので数百リクエスト/日程度を想定。

## 要件定義

### 機能要件

* REST API 経由でメール送信リクエストを受け付けたい
* メッセージをメッセージキューに登録し、ワーカーが非同期で送信処理を行いたい
* MailHog の UI で送信結果を確認できるようにしたい

### 非機能要件

* **パフォーマンス**: 秒間数十リクエスト程度を安定して処理できること
* **可用性**: 開発環境用なので単一ノード構成でも良い
* **コスト**: オープンソース利用 + Docker のみでコストゼロ
* **セキュリティ**: 外部インターネットには公開せず、開発ネットワーク内で閉じる

## 制約

* **使用技術の制限**: Docker Compose 上で動作させること。外部サービス（SendGrid, SES 等）は使わない。
* **チーム体制・スキル**: Flask / Python / Docker に基本的な知識を持つメンバー。

## 予算規模

* 0円（クラウド利用なし、すべてローカル開発環境）

## 期待収益

* 本番通知システムの安全な開発・検証環境を確立することで、誤送信やバグによる損失を回避。
* 将来的なマルチチャネル通知システムの基盤設計に活用できる。

## 専門用語解説

* **通知システム**: ユーザーにモバイルプッシュ、SMS、メールなどの様々な形式でメッセージを配信するシステム。
* **モバイルプッシュ通知**: アプリケーションが実行されていなくても、モバイルデバイスにメッセージを送信する機能。APN（Apple Push Notification Service, iOS）、FCM（Firebase Cloud Messaging, Android）が代表例。
* **SMS（Short Message Service）**: 携帯電話に短いテキストメッセージを送信するサービス。
* **Eメール（Email）**: 電子メールを送信するサービス。本要件定義では MailHog を利用。
* **メッセージキュー**: 通知リクエストを一時的に保存し、非同期で処理するために使用される。システム負荷を平準化し信頼性を高める。
* **ワーカー（Worker）**: メッセージキューから通知リクエストを取り出し、実際に通知を送信する処理を行うコンポーネント。
* **レートリミッター（Rate Limiter）**: ユーザーやサービスからの通知リクエスト数を制限し、システムの過負荷を防ぐ仕組み。
* **テンプレートエンジン（Template Engine）**: 通知の内容をパーソナライズするために、動的に内容を生成するコンポーネント。
* **サービスベースのアーキテクチャ**: 各通知タイプ（プッシュ、SMS、メール）ごとに独立したサービスを持つ構成。
* **メッセージキューとワーカーの分離**: 通知リクエストをメッセージキューに格納し、ワーカーが処理することでシステムの可用性とスケーラビリティを高める。
* **サードパーティサービスとの連携**: 実際のメッセージ送信には APN、FCM、Twilio、SendGrid などの外部プロバイダーを利用する。
* **水平スケーリング**: メッセージキューとワーカーを増やして大量の通知リクエストに対応する方法。
* **非同期処理**: メッセージキューを利用して通知処理を非同期化し、フロントエンドの応答性を高める。
* **データパーティショニング**: 通知ログやユーザー連絡先情報などを分割して保存し、データベース負荷を分散する。

## システム構成

```
[API (Flask)]
   │  POST /send
   ▼
[メッセージキュー (Redis)]
   │
   ▼
[ワーカー (Celery)]
   │
   ▼
[Eメール (MailHog)]
```

* API: メール送信リクエストを受け取り、キューに登録
* ワーカー: キューから取り出して送信
* MailHog: 受信メールを Web UI ([http://localhost:8025](http://localhost:8025)) で確認可能

## 成功基準

* Docker Compose の起動だけで環境が再現できること
* REST API でリクエストを送ると、MailHog UI にメールが表示されること
* 非同期処理（API → メッセージキュー → ワーカー → MailHog）が正しく機能すること
